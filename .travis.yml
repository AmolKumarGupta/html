language: php

env:
  global:
    - DEFAULT_COMPOSER_FLAGS="--prefer-dist --no-interaction --no-progress --optimize-autoloader"
    - TASK_STATIC_ANALYSIS=0
    - TASK_TESTS_COVERAGE=0

matrix:
  include:
    - php: "7.4"
      env:
        - TASK_STATIC_ANALYSIS=0 # set to 1 to enable static analysis
        - TASK_TESTS_COVERAGE=1

# faster builds on new travis setup not using sudo
sudo: false

# cache vendor dirs
cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - phpenv config-rm xdebug.ini || echo "xdebug is not installed"

install:
  - travis_retry composer self-update && composer --version
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - travis_retry composer install $DEFAULT_COMPOSER_FLAGS
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      pecl install ast
    fi

before_script:
  - php --version
  - composer --version
  # enable code coverage
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
        PHPUNIT_COVERAGE_FLAG="--coverage-clover=coverage.clover"
    fi

script:
  - phpdbg -qrr vendor/bin/phpunit --verbose $PHPUNIT_COVERAGE_FLAG
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      composer phan
    fi
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      cat analysis.txt
    fi

after_script:
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
      travis_retry wget https://scrutinizer-ci.com/ocular.phar
      php ocular.phar code-coverage:upload --format=php-clover coverage.clover
    fi


notifications:
  slack:
    -
      rooms:
        -
          secure: VXvfZgTkrFPWSZbJFFL761K4ZxydjebiYWroW+T/BPMe4CjWY+V7hZvSEYhu6t2gjbyDsPF5CU8qGFWDtKx0gZtV1BxsJakMqlbscil5y/n6/UBHf7w8ISWhMqP2tlX+nKilnqw+Mx+i9GV4p9ktJS0wCLA1CbBK3n56FdBdkjemdphSZWGvAmqcnqpb/fQdL2BsS9E6MwBQP4SknluUeu8rWgpPbUKQKvSKVCsezK08E2TwnSW/VXGDzab24JVjohxeoZZquwli36VUoRvo7zhthCBfmElUoyS0q6Hyx+zQEhAXpiqkEae0C+ZLH9a9RUi6J796dEhnojoP1DQITsCHcCEdtdGNZk2YUimLXYUzq5cAihUjyNBrcsj7MLbHwxDl3D4uk2fPu18gpFgKnG5aInHmp9+LR6l+3+xXGJRj6HkHsqHi2sASc8SKetbaV0toxIn5HP3xz9aAz9fO/y1JzNOS1l6pIPF8GWcCrGaTRGeZSe83g3TVEBC5BxVxx16f/MYHreqIpbzz3WN2pbNX17M8Z7pY1xA0vkWY9Y09wO0PYJc61rta525B+aPxk4N+8kqRf1TQzvZEUntWOboVD1v//elDwt8x7/gsvNLdp3sfXFksDQUj3ravDQLrsNL8Boq7BpVgE9o/ku8zKstfhYYxuEsGTWkvrzgzIRY=
      on_success: always
      on_failure: never
      on_pull_requests: false
    -
      rooms:
        -
          secure: 7B3Zcm3LG07wuWk+XXg/X3bBxpyvot7nC+jzb90QaCFat/pWWU7+xhtnI2We3AQ8l9Sp6RIOLei9p/mBDHleaeBOSYftC21zob6vPu56GNV2LiNILphUH0amKzettLAQztr3W5D7z8Srg7NLjDSUcFTbeSazSuzMWpBnv/4GzQjN4pUzKwFqDdAFhBCvMq27DlUGYK8GJZkGhWTfRdk9AzkQMWA6FrYLRvtRBjTBv7cOdPMyEAGhREHqNusW6D0JQsySZqpKg9q0qK1TZx2Xd4OgYu2tVF9g0JmqXfGBTfQx1G5WFjc3cTV11pUX53YUi1ugmFwZvy1marrM3/1YxlIE+599LhZlVtKh5W1YCixgeREKexOSuYiZl2WlIPNtfFEAA4fQwDMeuW4UgGoe70So8CChqNMZ135hmghKVh8Oxjylyz3l9DOvGD/IxfAUs7McKswx/rhG2vGx820TtH6BnLGRqE6ReQxcc+lRrgiB/gYI9POa3SN0Q4sqLp5Kd4ZDpAsIe8uQxJyuwzNCmotln5Q1D9dJWEQ/hiY8J4OxmbkdS2moEZ3zlFJHoqDoU4rtHS6o4Rnde6mHfLm08O6BcKp1yuxoM3kvm0fsczp6S+9HjYLMnP9L+PtmA6Bt2KzBzfZM9qcg3Jo3h9dsKGi8QysFz7eXKO4I/bOqfX0=
      on_success: never
      on_failure: always
      on_pull_requests: false
